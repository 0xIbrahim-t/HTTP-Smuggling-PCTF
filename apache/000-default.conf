# File: apache/000-default.conf

# Cache settings like NGINX
CacheRoot /var/cache/apache2
CacheEnable disk /api
CacheDisable /
CacheDirLevels 1
CacheDirLength 2
CacheDefaultExpire 60
CacheQuickHandler off
CacheIgnoreHeaders Set-Cookie
CacheHeader on

# Map equivalent for admin detection like NGINX
SetEnvIf Authorization "^Bearer.*role.*admin.*$" IS_ADMIN=1

# Map equivalent for cache key like NGINX
SetEnvIf X-Special-Key "^secret_cache_key$" CAN_SEE_CACHE=1

<VirtualHost *:443>
    ServerName _default_
    DocumentRoot "/usr/local/apache2/htdocs"
    
    # SSL Configuration
    SSLEngine on
    SSLCertificateFile /etc/apache2/certs/apache.crt
    SSLCertificateKeyFile /etc/apache2/certs/apache.key
    SSLProtocol TLSv1.2 TLSv1.3
    
    # HTTP/2 settings
    Protocols h2 http/1.1
    
    # Logging
    LogLevel debug
    CustomLog /usr/local/apache2/logs/access.log combined
    ErrorLog /usr/local/apache2/logs/error.log

    # Frontend location
    <Location />
        ProxyPass http://frontend:3000/
        ProxyPassReverse http://frontend:3000/
        
        # WebSocket support like NGINX
        RequestHeader set Upgrade $http_upgrade
        RequestHeader set Connection "upgrade"
        RequestHeader set Host "%{HTTP_HOST}e"
        ProxyPreserveHost On

        # Headers for frontend like NGINX
        Header always set Access-Control-Allow-Origin "*"
        Header always set Access-Control-Allow-Methods "GET, POST, OPTIONS"
        Header always set Access-Control-Allow-Headers "DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization"
    </Location>

    # Backend location
    <Location /api/>
        ProxyPass http://backend:5000/
        ProxyPassReverse http://backend:5000/

        # Basic headers
        RequestHeader set Host "%{HTTP_HOST}e"
        RequestHeader set X-Real-IP "%{REMOTE_ADDR}e"

        # HTTP smuggling settings
        RequestHeader unset Transfer-Encoding
        RequestHeader unset Content-Length
        
        # Allow headers to be passed through
        ProxyPreserveHost On

        # Cache control headers
        Header merge X-Cache-Status "%{cache-status}e"
        Header merge X-Is-Admin "%{IS_ADMIN}e"
        Header merge X-Can-See-Cache "%{CAN_SEE_CACHE}e"
        Header merge X-Have-TE "%{HAVE_TE}e"
        Header merge X-Have-CL "%{HAVE_CL}e"

        # Don't validate responses
        RequestHeader unset If-Modified-Since
        RequestHeader unset If-None-Match
        Header unset ETag
        Header unset Last-Modified
    </Location>
</VirtualHost>

<VirtualHost *:80>
    ServerName _default_
    DocumentRoot "/usr/local/apache2/htdocs"
    
    # Redirect all traffic to HTTPS
    Redirect permanent / https://%{HTTP_HOST}/
</VirtualHost>