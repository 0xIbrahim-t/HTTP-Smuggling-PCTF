# /usr/local/apache2/conf/httpd.conf

# Load required modules
LoadModule mpm_event_module modules/mod_mpm_event.so
LoadModule proxy_module modules/mod_proxy.so
LoadModule proxy_http_module modules/mod_proxy_http.so
LoadModule headers_module modules/mod_headers.so
LoadModule rewrite_module modules/mod_rewrite.so
LoadModule cache_module modules/mod_cache.so
LoadModule cache_disk_module modules/mod_cache_disk.so
LoadModule lua_module modules/mod_lua.so

# Global configuration
ServerRoot "/usr/local/apache2"
ServerName localhost
Define APACHE_LOG_ROOT "/usr/local/apache2/logs"

# Listen only on HTTP port
Listen 80

# MPM configuration
<IfModule mpm_event_module>
    StartServers             3
    MinSpareThreads         75
    MaxSpareThreads        250
    ThreadLimit            64
    ThreadsPerChild        25
    MaxRequestWorkers     400
    MaxConnectionsPerChild   0
    LimitRequestFieldSize 16384
    LimitRequestFields 100
</IfModule>

# Main HTTP VirtualHost
<VirtualHost *:80>
    ServerAdmin webmaster@localhost
    DocumentRoot "/usr/local/apache2/htdocs"
    ErrorLog ${APACHE_LOG_ROOT}/error.log
    CustomLog ${APACHE_LOG_ROOT}/access.log combined
    LogLevel debug
    
    # CORS Headers
    Header always set Access-Control-Allow-Origin "*"
    Header always set Access-Control-Allow-Methods "GET, POST, OPTIONS"
    Header always set Access-Control-Allow-Headers "DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization"

    # Proxy Configuration
    ProxyRequests Off
    ProxyPreserveHost On

    # Frontend Proxy
    ProxyPass / http://frontend:3000/ enablereuse=on timeout=300 retry=1 acquire=3000 connectiontimeout=300
    ProxyPassReverse / http://frontend:3000/

    # Backend API Proxy
    ProxyPass /api/ http://backend:5000/api/ enablereuse=on timeout=300 retry=1
    ProxyPassReverse /api/ http://backend:5000/api/

    # Cache configuration
    CacheRoot "/usr/local/apache2/cache"
    CacheEnable disk /
    CacheDefaultExpire 60
    CacheDirLevels 2
    CacheDirLength 1
    CacheMaxFileSize 1000000000  # 1GB
    
    # Custom Lua script for cache control
    LuaHookCheckCache "/usr/local/apache2/conf/cache_control.lua" check_cache_access

    # Vulnerability configurations
    # 1. HTTP Request Smuggling enablement
    SetEnv proxy-sendchunked 1
    SetEnv proxy-sendcl 1
    HttpProtocolOptions Unsafe

    # 2. Cache Poisoning enablement
    Header add X-Cache-Key "%{REQUEST_URI}e:%{HTTP:X-Special-Key}e"
    
    # 3. Admin token verification and cache handling
    SetEnvIf Authorization "Bearer.*role.*admin.*" ADMIN_USER=1
    SetEnvIf X-Special-Key "secret_cache_key" ENABLE_CACHE=1

    # Rewrite rules for admin cache handling
    RewriteEngine On
    RewriteCond %{ENV:ADMIN_USER} =1
    RewriteCond %{ENV:ENABLE_CACHE} =1
    RewriteRule .* - [E=SHOW_CACHE:1]
</VirtualHost>