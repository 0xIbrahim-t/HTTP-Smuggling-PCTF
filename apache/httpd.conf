# /usr/local/apache2/conf/httpd.conf

# Explicitly disable any automatic includes
IncludeOptional /dev/null/nonexistent

# Load required modules
LoadModule mpm_event_module /usr/local/apache2/modules/mod_mpm_event.so
LoadModule proxy_module /usr/local/apache2/modules/mod_proxy.so
LoadModule proxy_http_module /usr/local/apache2/modules/mod_proxy_http.so
LoadModule headers_module /usr/local/apache2/modules/mod_headers.so
LoadModule rewrite_module /usr/local/apache2/modules/mod_rewrite.so
LoadModule cache_module /usr/local/apache2/modules/mod_cache.so
LoadModule cache_disk_module /usr/local/apache2/modules/mod_cache_disk.so
LoadModule log_config_module /usr/local/apache2/modules/mod_log_config.so
LoadModule unixd_module /usr/local/apache2/modules/mod_unixd.so
LoadModule env_module /usr/local/apache2/modules/mod_env.so
LoadModule setenvif_module /usr/local/apache2/modules/mod_setenvif.so
LoadModule dir_module /usr/local/apache2/modules/mod_dir.so
LoadModule authz_core_module /usr/local/apache2/modules/mod_authz_core.so

# Global configuration
ServerRoot "/usr/local/apache2"
Define APACHE_LOG_ROOT "/usr/local/apache2/logs"

# User and group configuration
User www-data
Group www-data

# Basic directory permissions
<Directory />
    AllowOverride none
    Require all denied
</Directory>

<Directory "/usr/local/apache2/htdocs">
    Options Indexes FollowSymLinks
    AllowOverride None
    Require all granted
</Directory>

# Enable debug logging
LogLevel debug rewrite:trace3 cache:trace3

# Listen only on HTTP port
Listen 80

# MPM configuration
<IfModule mpm_event_module>
    StartServers             3
    MinSpareThreads         75
    MaxSpareThreads        250
    ThreadLimit            64
    ThreadsPerChild        25
    MaxRequestWorkers     400
    MaxConnectionsPerChild   0
    LimitRequestFieldSize 16384
    LimitRequestFields 100
</IfModule>

# Main HTTP VirtualHost
<VirtualHost *:80>
    ServerAdmin webmaster@localhost
    DocumentRoot "/usr/local/apache2/htdocs"
    ErrorLog ${APACHE_LOG_ROOT}/error.log
    CustomLog ${APACHE_LOG_ROOT}/access.log combined
    
    # Enhanced Debug headers
    Header always set X-Debug-Server-Name "%{SERVER_NAME}e"
    Header always set X-Debug-Request-URI "%{REQUEST_URI}e"
    Header always set X-Debug-Host "%{HTTP_HOST}e"
    Header always set X-Debug-Special-Key "%{HTTP:X-Special-Key}e"
    Header always set X-Debug-Auth "%{HTTP:Authorization}e"
    Header always set X-Debug-Cache-Status "%{CACHE_STATUS}e"
    Header always set X-Debug-Admin-Status "%{ADMIN_USER}e"
    Header always set X-Debug-Cache-Enable "%{ENABLE_CACHE}e"
    
    # CORS Headers
    Header always set Access-Control-Allow-Origin "*"
    Header always set Access-Control-Allow-Methods "GET, POST, OPTIONS"
    Header always set Access-Control-Allow-Headers "DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization,X-Special-Key"

    # Proxy Configuration
    ProxyRequests Off
    ProxyPreserveHost On

    # Backend API Proxy
    ProxyPass /api/ http://backend:5000/api/ enablereuse=on timeout=300 retry=1
    ProxyPassReverse /api/ http://backend:5000/api/

    # Frontend Proxy
    ProxyPass / http://frontend:3000/ enablereuse=on timeout=300 retry=1 acquire=3000 connectiontimeout=300
    ProxyPassReverse / http://frontend:3000/

    # Cache configuration
    CacheRoot "/usr/local/apache2/cache"
    CacheEnable disk /
    CacheDefaultExpire 60
    CacheDirLevels 2
    CacheDirLength 1
    CacheMaxFileSize 1000000

    # Enhanced cache control
    SetEnvIf Authorization "Bearer.*role.*admin.*" ADMIN_USER=1
    SetEnvIf X-Special-Key "secret_cache_key" ENABLE_CACHE=1
    SetEnvIf X-Special-Key "^(.+)$" CACHE_KEY=$1
    
    # Cache control headers
    Header set Cache-Control "no-cache" env=!ENABLE_CACHE
    Header set Cache-Control "public, max-age=60" env=ENABLE_CACHE

    # Vulnerability configurations
    # 1. HTTP Request Smuggling enablement
    SetEnv proxy-sendchunked 1
    SetEnv proxy-sendcl 1
    HttpProtocolOptions Unsafe

    # 2. Cache Poisoning enablement
    Header add X-Cache-Key "%{REQUEST_URI}e:%{CACHE_KEY}e" env=CACHE_KEY
    Header merge Cache-Control "must-revalidate" env=ADMIN_USER

    # Rewrite rules for admin cache handling
    RewriteEngine On
    RewriteCond %{ENV:ADMIN_USER} =1
    RewriteCond %{ENV:ENABLE_CACHE} =1
    RewriteRule .* - [E=SHOW_CACHE:1]

    # Additional cache debugging
    Header always set X-Cache-Debug "Key=%{CACHE_KEY}e,Admin=%{ADMIN_USER}e,Enable=%{ENABLE_CACHE}e"
</VirtualHost>